<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visagator Admin — Requests Dashboard</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --brand:#0A3D62;   /* navy/teal */
      --gold:#F39C12;    /* gold accent */

      --bg:#07101a;
      --cardA:rgba(255,255,255,.06);
      --cardB:rgba(255,255,255,.04);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --stroke:rgba(255,255,255,.14);
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --radius:18px;

      --ok:#3ddc97;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --chip:#0d1a28;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 12%, rgba(10,61,98,.45), transparent 62%),
        radial-gradient(980px 650px at 88% 14%, rgba(243,156,18,.20), transparent 62%),
        radial-gradient(900px 700px at 40% 110%, rgba(61,220,151,.10), transparent 65%),
        var(--bg);
      padding:24px 14px;
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto}
    .topbar{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,var(--cardA),var(--cardB));
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-bottom:14px;
    }
    .topbarInner{
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brandLockup{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:260px;
    }
    .brandLogo{
      width:170px;height:auto;display:block;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.25));
    }
    .badge{
      border:1px solid rgba(243,156,18,.35);
      background:rgba(243,156,18,.10);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      color:rgba(255,255,255,.84);
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .pill{
      font-size:12px;color:rgba(255,255,255,.78);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      padding:8px 10px;border-radius:999px;
      display:inline-flex;gap:8px;align-items:center;
    }
    .pill .dot{
      width:8px;height:8px;border-radius:999px;background:var(--gold);
      box-shadow:0 0 0 3px rgba(243,156,18,.18);
    }

    /* Cards */
    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,var(--cardA),var(--cardB));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardTop{
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .cardBody{padding:16px}

    /* Buttons */
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:850;
      font-size:13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      transition:transform .06s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
    .btn.primary{border-color:rgba(10,61,98,.85);background:rgba(10,61,98,.28)}
    .btn.gold{border-color:rgba(243,156,18,.55);background:rgba(243,156,18,.14)}
    .btn.danger{border-color:rgba(255,107,107,.55);background:rgba(255,107,107,.12)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}

    /* Inputs */
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .help{margin-top:6px;font-size:12px;color:var(--muted2);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:14px 0}

    /* Dashboard stat cards */
    .statsGrid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
    }
    @media (max-width:1100px){.statsGrid{grid-template-columns:repeat(3,minmax(0,1fr));}}
    @media (max-width:820px){.statsGrid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media (max-width:460px){.statsGrid{grid-template-columns:1fr;}}
    .stat{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      border-radius:16px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .stat::after{
      content:"";
      position:absolute;
      inset:-40px -60px auto auto;
      width:120px;height:120px;
      background:radial-gradient(circle at 30% 30%, rgba(243,156,18,.22), transparent 60%);
      transform:rotate(18deg);
      pointer-events:none;
    }
    .statTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .statIcon{
      width:36px;height:36px;border-radius:12px;
      display:grid;place-items:center;
      background:rgba(10,61,98,.22);
      border:1px solid rgba(10,61,98,.55);
      color:var(--gold);
      flex:0 0 auto;
    }
    .statValue{font-weight:950;font-size:22px;letter-spacing:.3px}
    .statLabel{margin-top:8px;color:rgba(255,255,255,.72);font-size:12px;line-height:1.25}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      font-size:12px;color:rgba(255,255,255,.78);
    }
    .chip.ok{border-color:rgba(61,220,151,.45);background:rgba(61,220,151,.12)}
    .chip.warn{border-color:rgba(255,204,102,.45);background:rgba(255,204,102,.12)}
    .chip.danger{border-color:rgba(255,107,107,.45);background:rgba(255,107,107,.12)}

    /* Table */
    .tableWrap{
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:980px;
    }
    th, td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      font-size:13px;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background:rgba(0,0,0,.28);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      user-select:none;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    .linkBtn{
      color:rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:900;
    }
    .muted{color:var(--muted2);font-size:12px}

    /* Status badge */
    .status{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      font-size:12px;
      color:rgba(255,255,255,.85);
    }
    .status.new{border-color:rgba(255,204,102,.45);background:rgba(255,204,102,.10)}
    .status.sent{border-color:rgba(10,61,98,.65);background:rgba(10,61,98,.18)}
    .status.final{border-color:rgba(61,220,151,.45);background:rgba(61,220,151,.12)}
    .status.rej{border-color:rgba(255,107,107,.45);background:rgba(255,107,107,.12)}

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      padding:18px;
      overflow:auto;
      z-index:50;
    }
    .overlay.show{display:block}
    .modal{
      max-width:980px;
      margin:20px auto;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(20,26,34,.98), rgba(10,14,20,.96));
      border-radius:18px;
      box-shadow:0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .modalBody{padding:16px}
    .kv{
      display:grid; grid-template-columns:180px 1fr; gap:10px;
      padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.10);
      font-size:13px;
    }
    @media (max-width:720px){ .kv{grid-template-columns:1fr} }
    .k{color:rgba(255,255,255,.70);font-size:12px}
    .v{color:rgba(255,255,255,.92);font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .errorBox{
      margin-top:10px;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.10);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      font-size:13px;
      line-height:1.4;
    }
    .errorBox.show{display:block}
  </style>
</head>

<body>
<div class="wrap">

  <!-- ============================================================
       TOP BAR
       ============================================================ -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="brandLockup">
        <!-- Easy: keep same logo file name + folder as user portal -->
        <img class="brandLogo" src="visagator-logo.png" alt="Visagator Logo">
        <div class="pill"><span class="dot"></span> Admin Portal</div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <div class="badge"><i class="fa-solid fa-lock" style="color:var(--gold)"></i> MVP Password Login</div>
        <button class="btn" id="btnLogout" type="button" style="display:none;">
          <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       LOGIN CARD
       ============================================================ -->
  <div class="card" id="loginCard">
    <div class="cardTop">
      <div>
        <div style="font-weight:950;">Login</div>
        <div class="muted">Enter admin password to view requests.</div>
      </div>
      <div class="pill">MVP only</div>
    </div>
    <div class="cardBody">
      <div class="grid">
        <div>
          <label for="adminPass">Admin password</label>
          <input id="adminPass" type="password" placeholder="Enter password" />
          <div class="help">
            MVP: password is stored in the code (not secure). Production: use real authentication.
          </div>
        </div>
        <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn primary" id="btnLogin" type="button">
            <i class="fa-solid fa-right-to-bracket"></i> Login
          </button>
          <button class="btn danger" id="btnResetAll" type="button" title="Deletes ALL local data">
            <i class="fa-solid fa-trash"></i> Reset Data
          </button>
        </div>
      </div>
      <div class="errorBox" id="loginErr"></div>
    </div>
  </div>

  <!-- ============================================================
       DASHBOARD
       ============================================================ -->
  <div id="dash" style="display:none;">

    <!-- Stats -->
    <div class="card" style="margin-bottom:14px;">
      <div class="cardTop">
        <div>
          <div style="font-weight:950;">Requests Dashboard</div>
          <div class="muted">Data source: <span class="mono">localStorage</span> (temporary MVP).</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="btnExportCsv" type="button"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
          <button class="btn gold" id="btnRefresh" type="button"><i class="fa-solid fa-rotate"></i> Refresh</button>
        </div>
      </div>
      <div class="cardBody">
        <div class="statsGrid">
          <div class="stat">
            <div class="statTop">
              <div class="statIcon"><i class="fa-solid fa-inbox"></i></div>
              <div style="text-align:right">
                <div class="statValue" id="statTotal">0</div>
                <div class="muted">All requests</div>
              </div>
            </div>
            <div class="statLabel">Total Requests</div>
          </div>
          <div class="stat">
            <div class="statTop">
              <div class="statIcon"><i class="fa-solid fa-bell"></i></div>
              <div style="text-align:right">
                <div class="statValue" id="statNew">0</div>
                <div class="muted">Needs action</div>
              </div>
            </div>
            <div class="statLabel">New</div>
          </div>
          <div class="stat">
            <div class="statTop">
              <div class="statIcon"><i class="fa-solid fa-paper-plane"></i></div>
              <div style="text-align:right">
                <div class="statValue" id="statSent">0</div>
                <div class="muted">Quotes sent</div>
              </div>
            </div>
            <div class="statLabel">Quote Sent</div>
          </div>
          <div class="stat">
            <div class="statTop">
              <div class="statIcon"><i class="fa-solid fa-circle-check"></i></div>
              <div style="text-align:right">
                <div class="statValue" id="statFinal">0</div>
                <div class="muted">Completed</div>
              </div>
            </div>
            <div class="statLabel">Finalized</div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Filters -->
        <div class="grid">
          <div>
            <label for="qSearch">Search (Request ID / Name / Email / Phone)</label>
            <input id="qSearch" type="text" placeholder="e.g., VIS-20251222-0001 or John" />
          </div>
          <div>
            <label for="qStatus">Status</label>
            <select id="qStatus">
              <option value="">All</option>
              <option value="New">New</option>
              <option value="Quote Sent">Quote Sent</option>
              <option value="Finalized">Finalized</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
          <div>
            <label for="qFrom">From (date)</label>
            <input id="qFrom" type="date" />
          </div>
          <div>
            <label for="qTo">To (date)</label>
            <input id="qTo" type="date" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <span class="chip ok"><i class="fa-solid fa-database"></i> Stored locally</span>
            <span class="chip warn"><i class="fa-solid fa-triangle-exclamation"></i> Not secure</span>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn" id="btnClearFilters" type="button"><i class="fa-solid fa-eraser"></i> Clear Filters</button>
            <button class="btn primary" id="btnApplyFilters" type="button"><i class="fa-solid fa-filter"></i> Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="cardTop">
        <div>
          <div style="font-weight:950;">All Requests</div>
          <div class="muted">Click a request to view full details, update status, and add admin notes.</div>
        </div>
        <div class="pill">Sort: click headers</div>
      </div>
      <div class="cardBody">
        <div class="tableWrap">
          <table id="reqTable">
            <thead>
              <tr>
                <th data-sort="requestId">Request ID</th>
                <th data-sort="submittedAtISO">Submission Date</th>
                <th data-sort="name">Name</th>
                <th data-sort="email">Email</th>
                <th data-sort="phone">Phone</th>
                <th data-sort="visaType">Visa Type</th>
                <th data-sort="travCount">Travelers</th>
                <th data-sort="status">Status</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody id="reqTbody"></tbody>
          </table>
        </div>
        <div class="help" style="margin-top:10px;">
          <b>How to use:</b> Put <span class="mono">admin.html</span> in the same folder as <span class="mono">visagator.html</span> (and logo).
          This reads requests saved by the user portal from <span class="mono">localStorage</span>.
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ============================================================
     DETAILS MODAL
     ============================================================ -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:950;">Request Details</div>
        <div class="muted"><span class="mono" id="mReqId">—</span></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" id="mClose" type="button"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="grid">
        <div class="card" style="box-shadow:none;">
          <div class="cardTop">
            <div style="font-weight:950;">Summary</div>
            <div id="mStatusChip" class="status new">New</div>
          </div>
          <div class="cardBody" id="mSummary"></div>
        </div>

        <div class="card" style="box-shadow:none;">
          <div class="cardTop">
            <div style="font-weight:950;">Actions</div>
            <div class="pill">MVP</div>
          </div>
          <div class="cardBody">
            <div>
              <label for="mStatus">Update Status</label>
              <select id="mStatus">
                <option>New</option>
                <option>Quote Sent</option>
                <option>Finalized</option>
                <option>Rejected</option>
              </select>
              <div class="help">If you set <b>Finalized</b>, we also set <span class="mono">finalizedAtISO</span> (used by homepage Avg Processing).</div>
            </div>

            <div class="divider"></div>

            <div>
              <label for="mNotes">Admin Notes</label>
              <textarea id="mNotes" placeholder="Add internal notes..."></textarea>
              <div class="help">Saved in localStorage for this request.</div>
            </div>

            <div class="divider"></div>

            <div class="row" style="justify-content:flex-end;">
              <button class="btn" id="mDownloadPdf" type="button"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
              <button class="btn primary" id="mSave" type="button"><i class="fa-solid fa-floppy-disk"></i> Save</button>
            </div>

            <div class="help" style="margin-top:10px;">
              PDF note: this portal regenerates the PDF from stored data. (No server yet.)
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="card" style="box-shadow:none;">
        <div class="cardTop">
          <div style="font-weight:950;">Travelers</div>
          <div class="pill" id="mTravCount">0</div>
        </div>
        <div class="cardBody" id="mTravelers"></div>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ============================================================================
  VISAGATOR ADMIN — Single File (admin.html)

  What it does:
  - Reads quote requests saved by visagator.html from localStorage
  - Shows a sortable, filterable dashboard table
  - Click request to open full details
  - Update status + admin notes
  - Download a PDF summary (generated client-side)

  IMPORTANT MVP LIMITS:
  - localStorage is per-browser and NOT secure
  - login password is in code and can be viewed by anyone
  - use this only for demos / MVP

  Production upgrade:
  - replace localStorage with a database (PostgreSQL / MySQL / MongoDB)
  - add proper auth (JWT, OAuth, session cookies)
  - store PDFs and audio blobs on server / S3 and save URLs
============================================================================ */

/* ---- MUST MATCH user portal ---- */
const REQUESTS_KEY = "visagator_requests_v1";

/* ---- MVP password (change this) ---- */
const ADMIN_PASSWORD = "visagator123";

/* ---- Remember login in this browser (still not secure) ---- */
const SESSION_KEY = "visagator_admin_session_v1";

/* DOM */
const $ = s => document.querySelector(s);

const loginCard = $("#loginCard");
const dash = $("#dash");

const adminPass = $("#adminPass");
const btnLogin = $("#btnLogin");
const btnLogout = $("#btnLogout");
const loginErr = $("#loginErr");
const btnResetAll = $("#btnResetAll");

const btnExportCsv = $("#btnExportCsv");
const btnRefresh = $("#btnRefresh");

const qSearch = $("#qSearch");
const qStatus = $("#qStatus");
const qFrom = $("#qFrom");
const qTo = $("#qTo");
const btnClearFilters = $("#btnClearFilters");
const btnApplyFilters = $("#btnApplyFilters");

const statTotal = $("#statTotal");
const statNew = $("#statNew");
const statSent = $("#statSent");
const statFinal = $("#statFinal");

const reqTbody = $("#reqTbody");

/* Modal */
const overlay = $("#overlay");
const mClose = $("#mClose");
const mReqId = $("#mReqId");
const mSummary = $("#mSummary");
const mTravelers = $("#mTravelers");
const mTravCount = $("#mTravCount");
const mStatusChip = $("#mStatusChip");
const mStatus = $("#mStatus");
const mNotes = $("#mNotes");
const mSave = $("#mSave");
const mDownloadPdf = $("#mDownloadPdf");

/* State */
let allRequests = [];
let filtered = [];
let sortKey = "submittedAtISO";
let sortDir = "desc";
let activeId = null;

/* Init */
init();

/* ============================
   INIT + LOGIN
============================ */
function init(){
  const isAuthed = localStorage.getItem(SESSION_KEY) === "1";
  if(isAuthed) showDashboard(); else showLogin();

  btnLogin.addEventListener("click", login);
  adminPass.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });

  btnLogout.addEventListener("click", ()=>{
    localStorage.removeItem(SESSION_KEY);
    showLogin();
  });

  btnResetAll.addEventListener("click", ()=>{
    const ok = confirm("This will delete ALL Visagator requests stored in this browser. Continue?");
    if(!ok) return;
    localStorage.removeItem(REQUESTS_KEY);
    alert("Local data cleared.");
  });

  btnExportCsv.addEventListener("click", exportCsv);
  btnRefresh.addEventListener("click", refreshData);

  btnApplyFilters.addEventListener("click", applyFilters);
  btnClearFilters.addEventListener("click", ()=>{
    qSearch.value=""; qStatus.value=""; qFrom.value=""; qTo.value="";
    applyFilters();
  });

  // Table sorting (click headers)
  document.querySelectorAll("th[data-sort]").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = th.getAttribute("data-sort");
      if(sortKey === key) sortDir = (sortDir==="asc") ? "desc" : "asc";
      else { sortKey = key; sortDir = "asc"; }
      renderTable();
    });
  });

  // Modal
  mClose.addEventListener("click", closeModal);
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });

  mSave.addEventListener("click", saveActiveRequest);
  mDownloadPdf.addEventListener("click", downloadActivePdf);
}

function showLogin(){
  loginCard.style.display = "";
  dash.style.display = "none";
  btnLogout.style.display = "none";
  setLoginErr("");
}

function showDashboard(){
  loginCard.style.display = "none";
  dash.style.display = "";
  btnLogout.style.display = "";
  refreshData();
}

function setLoginErr(msg){
  if(!msg){ loginErr.classList.remove("show"); loginErr.textContent=""; return; }
  loginErr.classList.add("show"); loginErr.textContent = msg;
}

function login(){
  const entered = String(adminPass.value || "").trim();
  if(!entered) return setLoginErr("Please enter the admin password.");
  if(entered !== ADMIN_PASSWORD) return setLoginErr("Incorrect password.");
  localStorage.setItem(SESSION_KEY, "1");
  adminPass.value = "";
  showDashboard();
}

/* ============================
   DATA LOAD / SAVE
============================ */
function loadRequests(){
  try{ return JSON.parse(localStorage.getItem(REQUESTS_KEY) || "[]"); }
  catch{ return []; }
}
function saveRequests(arr){
  localStorage.setItem(REQUESTS_KEY, JSON.stringify(arr));
}

function refreshData(){
  allRequests = loadRequests().map(normalizeRequest);
  applyFilters();
}

/* Normalize for table sort/filter safety */
function normalizeRequest(r){
  const contact = r?.contact || {};
  const travelers = Array.isArray(r?.travelers) ? r.travelers : [];
  const firstVisa = travelers[0]?.visaType || "-";
  return {
    ...r,
    requestId: r?.requestId || "",
    submittedAtISO: r?.submittedAtISO || "",
    status: r?.status || "New",
    adminNotes: r?.adminNotes || "",
    contact: {
      fullName: contact.fullName || "",
      email: contact.email || "",
      phone: contact.phone || ""
    },
    _table: {
      name: contact.fullName || "",
      email: contact.email || "",
      phone: contact.phone || "",
      visaType: firstVisa,
      travCount: travelers.length
    }
  };
}

/* ============================
   FILTERS + SORT + RENDER
============================ */
function applyFilters(){
  const s = String(qSearch.value || "").toLowerCase().trim();
  const st = String(qStatus.value || "").trim();
  const from = qFrom.value ? new Date(qFrom.value + "T00:00:00").getTime() : null;
  const to = qTo.value ? new Date(qTo.value + "T23:59:59").getTime() : null;

  filtered = allRequests.filter(r=>{
    // Status
    if(st && r.status !== st) return false;

    // Date range
    if(from || to){
      const t = r.submittedAtISO ? new Date(r.submittedAtISO).getTime() : 0;
      if(from && t < from) return false;
      if(to && t > to) return false;
    }

    // Search string
    if(s){
      const hay = [
        r.requestId,
        r.contact.fullName,
        r.contact.email,
        r.contact.phone
      ].join(" ").toLowerCase();
      if(!hay.includes(s)) return false;
    }

    return true;
  });

  renderStats();
  renderTable();
}

function renderStats(){
  const total = allRequests.length;
  const nNew = allRequests.filter(r=>r.status==="New").length;
  const nSent = allRequests.filter(r=>r.status==="Quote Sent").length;
  const nFinal = allRequests.filter(r=>r.status==="Finalized").length;

  statTotal.textContent = total;
  statNew.textContent = nNew;
  statSent.textContent = nSent;
  statFinal.textContent = nFinal;
}

function renderTable(){
  const rows = [...filtered].sort((a,b)=>compare(a,b,sortKey,sortDir));
  reqTbody.innerHTML = rows.map(r=>{
    const date = r.submittedAtISO ? new Date(r.submittedAtISO).toLocaleString() : "-";
    return `
      <tr>
        <td><span class="mono">${escapeHtml(r.requestId)}</span></td>
        <td>${escapeHtml(date)}</td>
        <td>${escapeHtml(r.contact.fullName || "-")}</td>
        <td>${escapeHtml(r.contact.email || "-")}</td>
        <td>${escapeHtml(r.contact.phone || "-")}</td>
        <td>${escapeHtml(r._table.visaType || "-")}</td>
        <td>${r._table.travCount}</td>
        <td>${statusBadge(r.status)}</td>
        <td>
          <a href="#" class="linkBtn" data-open="${escapeAttr(r.requestId)}">
            View <i class="fa-solid fa-arrow-up-right-from-square"></i>
          </a>
        </td>
      </tr>
    `;
  }).join("");

  // Bind open handlers
  reqTbody.querySelectorAll("[data-open]").forEach(a=>{
    a.addEventListener("click",(e)=>{
      e.preventDefault();
      openModal(a.getAttribute("data-open"));
    });
  });
}

function compare(a,b,key,dir){
  const va = valueForSort(a,key);
  const vb = valueForSort(b,key);

  if(va < vb) return dir==="asc" ? -1 : 1;
  if(va > vb) return dir==="asc" ? 1 : -1;
  return 0;
}

function valueForSort(r,key){
  switch(key){
    case "requestId": return r.requestId || "";
    case "submittedAtISO": return r.submittedAtISO || "";
    case "name": return r.contact.fullName || "";
    case "email": return r.contact.email || "";
    case "phone": return r.contact.phone || "";
    case "visaType": return r._table.visaType || "";
    case "travCount": return Number(r._table.travCount || 0);
    case "status": return r.status || "";
    default: return "";
  }
}

function statusBadge(status){
  const s = String(status||"New");
  const cls = (s==="New") ? "new" :
              (s==="Quote Sent") ? "sent" :
              (s==="Finalized") ? "final" : "rej";
  return `<span class="status ${cls}">${escapeHtml(s)}</span>`;
}

/* ============================
   MODAL DETAILS
============================ */
function openModal(requestId){
  const r = allRequests.find(x=>x.requestId===requestId);
  if(!r) return alert("Request not found.");

  activeId = requestId;
  mReqId.textContent = requestId;

  // Status + notes
  mStatus.value = r.status || "New";
  mNotes.value = r.adminNotes || "";
  setStatusChip(r.status);

  // Summary block
  const when = r.submittedAtISO ? new Date(r.submittedAtISO).toLocaleString() : "-";
  mSummary.innerHTML = `
    ${kv("Request ID", `<span class="mono">${escapeHtml(r.requestId)}</span>`)}
    ${kv("Submitted", escapeHtml(when))}
    ${kv("Name", escapeHtml(r.contact.fullName || "-"))}
    ${kv("Email", escapeHtml(r.contact.email || "-"))}
    ${kv("Phone", escapeHtml(r.contact.phone || "-"))}
    ${kv("Travelers", String((r.travelers||[]).length))}
    ${kv("First Visa Type", escapeHtml((r.travelers?.[0]?.visaType) || "-"))}
    ${kv("Audio Attached", r?.additional?.audioAttached ? "Yes" : "No")}
    ${kv("Comments", escapeHtml((r?.additional?.comments) || "-"))}
  `;

  // Travelers block
  const trav = Array.isArray(r.travelers) ? r.travelers : [];
  mTravCount.textContent = String(trav.length);

  mTravelers.innerHTML = trav.map((t, idx)=>{
    return `
      <div class="card" style="box-shadow:none;margin-bottom:12px;">
        <div class="cardTop">
          <div style="font-weight:950;">Traveler ${idx+1}</div>
          <div class="pill">${escapeHtml(t.visaType || "-")}</div>
        </div>
        <div class="cardBody">
          ${kv("Gender", escapeHtml(t.gender || "-"))}
          ${kv("DOB", escapeHtml(t.dob || "-"))}
          ${kv("Nationality", escapeHtml(t.nationality || "-"))}
          ${kv("Last UAE Travel", t.neverVisitedUAE ? "Never visited" : escapeHtml(t.lastUaeTravel || "-"))}
          ${kv("Expected UAE Travel", escapeHtml(t.expectedUaeTravel || "-"))}
        </div>
      </div>
    `;
  }).join("");

  overlay.classList.add("show");
}

function closeModal(){
  overlay.classList.remove("show");
  activeId = null;
}

function kv(k,v){
  return `<div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>`;
}

function setStatusChip(status){
  const s = String(status||"New");
  mStatusChip.className = "status " + (
    s==="New" ? "new" :
    s==="Quote Sent" ? "sent" :
    s==="Finalized" ? "final" : "rej"
  );
  mStatusChip.textContent = s;
}

/* Save status + notes back to localStorage */
function saveActiveRequest(){
  if(!activeId) return;
  const all = loadRequests();

  const idx = all.findIndex(r=>r?.requestId===activeId);
  if(idx < 0) return alert("Could not save. Request not found.");

  const newStatus = String(mStatus.value || "New");
  all[idx].status = newStatus;
  all[idx].adminNotes = String(mNotes.value || "");

  // If finalized, stamp finalizedAtISO (used for Avg Processing on homepage)
  if(newStatus === "Finalized" && !all[idx].finalizedAtISO){
    all[idx].finalizedAtISO = new Date().toISOString();
  }

  saveRequests(all);
  refreshData();

  // Refresh modal UI
  const updated = allRequests.find(r=>r.requestId===activeId);
  if(updated) setStatusChip(updated.status);
  alert("Saved.");
}

/* ============================
   EXPORT CSV
============================ */
function exportCsv(){
  // Export all (unfiltered) OR filtered? — We'll export filtered for convenience.
  const rows = [...filtered].sort((a,b)=>compare(a,b,sortKey,sortDir));

  const header = [
    "Request ID","Submission Date","Name","Email","Phone","Visa Type",
    "Number of Travelers","Status","Admin Notes"
  ];

  const lines = [header.join(",")];

  for(const r of rows){
    const date = r.submittedAtISO ? new Date(r.submittedAtISO).toISOString() : "";
    const visa = r._table.visaType || "";
    const row = [
      csv(r.requestId),
      csv(date),
      csv(r.contact.fullName),
      csv(r.contact.email),
      csv(r.contact.phone),
      csv(visa),
      csv(String(r._table.travCount)),
      csv(r.status),
      csv(r.adminNotes || "")
    ];
    lines.push(row.join(","));
  }

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `visagator_requests_export_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function csv(v){
  const s = String(v ?? "");
  const escaped = s.replaceAll('"','""');
  return `"${escaped}"`;
}

/* ============================
   PDF (admin portal) — regenerated from data
============================ */
async function downloadActivePdf(){
  if(!activeId) return;
  const r = allRequests.find(x=>x.requestId===activeId);
  if(!r) return alert("Request not found.");

  try{
    const url = await generatePdfBlobUrl(r);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${r.requestId}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }catch(e){
    console.error(e);
    alert("PDF generation failed. Please try again.");
  }
}

async function generatePdfBlobUrl(record){
  if(!window.jspdf || !window.jspdf.jsPDF) throw new Error("jsPDF not loaded");
  const { jsPDF } = window.jspdf;

  const doc = new jsPDF({ unit:"pt", format:"a4" });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 44;
  let y = 52;

  doc.setFont("helvetica","bold"); doc.setFontSize(16);
  doc.text("UAE Tourist Visa Quote Request (Visagator)", margin, y); y += 18;

  doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(90);
  doc.text(`Request ID: ${record.requestId}`, margin, y); y += 12;
  doc.text(`Submitted: ${record.submittedAtISO ? new Date(record.submittedAtISO).toLocaleString() : "-"}`, margin, y); y += 12;
  doc.text(`Status: ${record.status || "New"}`, margin, y); y += 16;

  doc.setTextColor(70);
  const privacy = "Privacy note: Name and contact details will not be shared with vendors until the requester finalizes a quote.";
  const pLines = doc.splitTextToSize(privacy, pageW - margin*2);
  doc.text(pLines, margin, y); y += (pLines.length * 12) + 10;

  doc.setDrawColor(200); doc.line(margin, y, pageW-margin, y); y += 18;

  y = pdfSection(doc, "Contact Information", margin, y);
  y = pdfKV(doc, "Full name", record.contact?.fullName || "-", margin, y);
  y = pdfKV(doc, "Email", record.contact?.email || "-", margin, y);
  y = pdfKV(doc, "Contact number", record.contact?.phone || "-", margin, y);
  y += 10;

  y = pdfSection(doc, "Applicants / Travelers", margin, y);
  (record.travelers||[]).forEach((t, idx)=>{
    y = pdfSub(doc, `Traveler ${idx+1}`, margin, y);
    y = pdfKV(doc, "Visa type", t.visaType || "-", margin, y);
    y = pdfKV(doc, "Gender", t.gender || "-", margin, y);
    y = pdfKV(doc, "Date of birth", t.dob || "-", margin, y);
    y = pdfKV(doc, "Nationality", t.nationality || "-", margin, y);
    y = pdfKV(doc, "Last UAE travel", t.neverVisitedUAE ? "Never visited" : (t.lastUaeTravel || "-"), margin, y);
    y = pdfKV(doc, "Expected UAE travel", t.expectedUaeTravel || "-", margin, y);
    y += 8;
    if(y > 760){ doc.addPage(); y = 52; }
  });

  y = pdfSection(doc, "Additional Information", margin, y);
  y = pdfKV(doc, "Comments", record.additional?.comments || "-", margin, y);
  y = pdfKV(doc, "Audio attached", record.additional?.audioAttached ? "Yes" : "No", margin, y);

  y += 10;
  y = pdfSection(doc, "Admin Notes", margin, y);
  y = pdfKV(doc, "Notes", record.adminNotes || "-", margin, y);

  const bytes = doc.output("arraybuffer");
  const blob = new Blob([bytes], { type:"application/pdf" });
  return URL.createObjectURL(blob);
}

function pdfSection(doc, title, margin, y){
  doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(30);
  doc.text(title, margin, y); y += 12;
  doc.setDrawColor(220);
  doc.line(margin, y, doc.internal.pageSize.getWidth()-margin, y);
  y += 14;
  return y;
}
function pdfSub(doc, title, margin, y){
  doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(40);
  doc.text(title, margin, y); y += 14;
  return y;
}
function pdfKV(doc, key, value, margin, y){
  const pageW = doc.internal.pageSize.getWidth();
  const keyW = 160;
  const maxW = pageW - margin*2 - keyW;

  doc.setFont("helvetica","bold"); doc.setFontSize(10); doc.setTextColor(50);
  doc.text(`${key}:`, margin, y);

  doc.setFont("helvetica","normal"); doc.setTextColor(60);
  const lines = doc.splitTextToSize(String(value ?? ""), maxW);
  doc.text(lines, margin + keyW, y);

  y += Math.max(12, lines.length * 12);
  if(y > 780){ doc.addPage(); y = 52; }
  return y;
}

/* ============================
   UTIL
============================ */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return String(str ?? "").replaceAll('"',"&quot;");
}
</script>

<!--
HOW TO USE (Beginner Friendly):
1) Save this file as: admin.html
2) Keep it in the same folder as visagator.html and visagator-logo.png
3) Open visagator.html, submit a test request
4) Open admin.html, login with password: visagator123

IMPORTANT:
- localStorage is per-browser and per-device, so admin.html will only see requests created on the SAME browser/device.

FUTURE DATABASE MIGRATION:
- Replace loadRequests/saveRequests with API calls:
  GET /api/requests
  PATCH /api/requests/:id (status, notes)
  GET /api/requests/:id/pdf (server-generated PDF)
- Add authentication with sessions/JWT and role-based access.
-->
</body>
</html>
